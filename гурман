from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler,
    ContextTypes, filters
)
import requests
import random

TOKEN = "–¢–û–ö–ï–ù_–¢–í–û–ï–ì–û_–ë–û–¢–ê"  # ‚Üê —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
WEATHER_API_KEY = "–ö–õ–Æ–ß_–ü–û–ì–û–î–´"  # ‚Üê –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞ openweathermap.org/api

# === /start ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üåç –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫", callback_data="translate")],
        [InlineKeyboardButton("‚òÄ –ü–æ–≥–æ–¥–∞", callback_data="weather")],
        [InlineKeyboardButton("üéØ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞", callback_data="quiz")],
        [InlineKeyboardButton("üí¨ –ü–æ–±–æ–ª—Ç–∞—Ç—å", callback_data="chat")]
    ]
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ ü§ñ\n–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# === –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ===
async def menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    choice = query.data

    if choice == "translate":
        await query.message.reply_text("–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ (—Ä—É—Å—Å–∫–∏–π ‚Üî –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)")
        context.user_data["mode"] = "translate"
    elif choice == "weather":
        await query.message.reply_text("–ù–∞–ø–∏—à–∏ –≥–æ—Ä–æ–¥, –∏ —è –ø–æ–∫–∞–∂—É –ø–æ–≥–æ–¥—É ‚òÅÔ∏è")
        context.user_data["mode"] = "weather"
    elif choice == "quiz":
        await send_quiz(update, context)
    elif choice == "chat":
        await query.message.reply_text("–ü–∏—à–∏ —á—Ç–æ —Ö–æ—á–µ—à—å, –ø–æ–±–æ–ª—Ç–∞–µ–º üí¨")
        context.user_data["mode"] = "chat"

# === –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ ===
QUIZ = [
    ("–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?", "–ü–∞—Ä–∏–∂"),
    ("–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 5 √ó 6?", "30"),
    ("–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ø—É—Ç–Ω–∏–∫ –ó–µ–º–ª–∏?", "–õ—É–Ω–∞"),
]

async def send_quiz(update: Update, context):
    question, answer = random.choice(QUIZ)
    context.user_data["quiz_answer"] = answer.lower()
    await update.callback_query.message.reply_text(f"üéØ –í–∏–∫—Ç–æ—Ä–∏–Ω–∞:\n{question}")

# === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ===
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    mode = context.user_data.get("mode", None)
    text = update.message.text.strip()

    # –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫
    if mode == "translate":
        url = f"https://api.mymemory.translated.net/get?q={text}&langpair=ru|en"
        res = requests.get(url).json()
        translated = res["responseData"]["translatedText"]
        await update.message.reply_text(f"–ü–µ—Ä–µ–≤–æ–¥: {translated}")

    # –ü–æ–≥–æ–¥–∞
    elif mode == "weather":
        url = f"http://api.openweathermap.org/data/2.5/weather?q={text}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
        res = requests.get(url).json()
        if res.get("main"):
            temp = res["main"]["temp"]
            desc = res["weather"][0]["description"]
            await update.message.reply_text(f"–ü–æ–≥–æ–¥–∞ –≤ {text}: {temp}¬∞C, {desc}")
        else:
            await update.message.reply_text("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω üòø")

    # –í–∏–∫—Ç–æ—Ä–∏–Ω–∞
    elif "quiz_answer" in context.user_data:
        correct = context.user_data["quiz_answer"]
        if text.lower() == correct:
            await update.message.reply_text("‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!")
        else:
            await update.message.reply_text(f"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct}")
        context.user_data.pop("quiz_answer")

    # –ß–∞—Ç (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
    elif mode == "chat":
        responses = [
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ üò∫",
            "–û, —è –¥—É–º–∞–ª –æ —Ç–æ–º –∂–µ!",
            "–•–º–º‚Ä¶ –∞ —Ç—ã –∫–∞–∫ —Å—á–∏—Ç–∞–µ—à—å?",
            "–•–∞-—Ö–∞, –∑–∞–±–∞–≤–Ω–æ üòÜ",
        ]
        await update.message.reply_text(random.choice(responses))

    else:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ /start üòä")

# === –ó–∞–ø—É—Å–∫ ===
def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(menu))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()

if __name__ == "__main__":
    main() 
elif mode == "weather":
        url = f"http://api.openweathermap.org/data/2.5/weather?q={text}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
        res = requests.get(url).json()

        if res.get("main"):
            temp = res["main"]["temp"]
            feels = res["main"]["feels_like"]
            humidity = res["main"]["humidity"]
            wind = res["wind"]["speed"]
            desc = res["weather"][0]["description"]
            icon = res["weather"][0]["icon"]

            # –≠–º–æ–¥–∑–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–≥–æ–¥—ã
            if "01" in icon:
                emoji = "‚òÄÔ∏è"
            elif "02" in icon or "03" in icon or "04" in icon:
                emoji = "üå§Ô∏è"
            elif "09" in icon or "10" in icon:
                emoji = "üåßÔ∏è"
            elif "11" in icon:
                emoji = "‚õàÔ∏è"
            elif "13" in icon:
                emoji = "‚ùÑÔ∏è"
            elif "50" in icon:
                emoji = "üå´Ô∏è"
            else:
                emoji = "üåà"

            await update.message.reply_text(
                f"{emoji} *–ü–æ–≥–æ–¥–∞ –≤ {text}:*\n"
                f"üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels}¬∞C)\n"
                f"üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity}%\n"
                f"üí® –í–µ—Ç–µ—Ä: {wind} –º/—Å\n"
                f"üìã –û–ø–∏—Å–∞–Ω–∏–µ: {desc.capitalize()}",
                parse_mode="Markdown"
            )
        else:
            await update.message.reply_text("üòø –ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
